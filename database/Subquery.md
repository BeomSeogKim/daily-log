# Subquery
하나의 SQL 쿼리문 안에 포함된 또 다른 쿼리를 의미한다.

서브쿼리의 경우 바깥쪽의 메인 쿼리가 실행되기 전에, 괄호 안의 서브 쿼리가 먼저 실행된다.

```sql
SELECT p.name, p.price
FROM products p
WHERE p.price > (SELECT AVG(price) FROM products);
```

해당 쿼리에서 `SELECT AVG(price) FROM products` 가 제일 먼저 실행된다.

## 서브 쿼리의 종류와 특징
| 구분    | 반환 형태 | 주요 사용 위치              | 명칭          |
|-------|-------|-----------------------|-------------|
| 단일 컬럼 | 단일 행  | SELECT, WHERE, HAVING | 스칼라 서브쿼리    |
|       | 다중 행  | WHERE, HAVING         | 다중 행 서브쿼리   |
| 다중 컬럼 | 단일 행  | WHERE, HAVING         | 다중 컬럼 서브 쿼리 |
|       | 다중 행  | WHERE, HAVING         | 다중 컬럼 서브 쿼리 |
| 다중 컬럼 | 다중 행  | FROM                  | 테이블 서브 쿼리   |

## 상관 서브쿼리
서브 쿼리가 메인 쿼리에서 처리 중인 행의 특정값을 알아야만 수행을 할 수 있는 경우를 의미한다.

예를 들어, 회원이 속한 나이대 별 평균 구매 금액을 구해야 하는 경우 회원 개개인의 나이대에 따라 동적으로 해당 그룹을 해야 한다.

_**상관 서브쿼리 비상관 서브쿼리 동작 방식**_

- 비상관 서브쿼리 (Non-correlated)
  - 서브쿼리가 **한번** 실행 된 후, 해당 결과를 메인 쿼리가 사용
- 상관 서브쿼리 (Correlated)
  - 메인쿼리가 한 행을 읽음
  - 읽은 행을 토대로 서브쿼리 실행
  - 서브쿼리 결과에 따른 추가 동작 진행

_상관 서브쿼리의 경우 복잡한 쿼리를 직관적으로 볼 수 있지만 성능에 주의를 해야 한다._

## 테이블 서브 쿼리
`FROM` 절에 위치하는 서브쿼리의 경우 가상 테이블처럼 사용되기에 테이블 서브 쿼리라 불린다.

복잡한 쿼리문을 하나의 명확한 데이터 집합으로 먼전 만든 후, 다시 SELECT을 할 수 있도록 해준다는 장점이 존재한다. 